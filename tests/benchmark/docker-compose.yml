# Benchmark environment for Rift vs Mountebank performance comparison
#
# This setup runs both services with identical configurations to ensure
# fair performance comparison.
#
# Usage:
#   docker compose up -d --build
#   ./scripts/run-benchmark.sh
#   docker compose down -v

services:
  # Original Mountebank
  mountebank:
    image: bbyars/mountebank:2.9.2
    container_name: mb-bench
    ports:
      - "2525:2525"   # Admin API
      - "4545:4545"   # API Server
      - "4546:4546"   # Regex Matcher
      - "4547:4547"   # Complex Predicates
      - "4548:4548"   # Behaviors
      - "4549:4549"   # Simple Baseline
      - "4550:4550"   # JSON Body Matcher
      - "4551:4551"   # JSONPath Matcher
      - "4552:4552"   # XPath Matcher
      - "4553:4553"   # Template Responses
      - "4554:4554"   # Header Router
      - "4555:4555"   # Query Param Matcher
      - "4556:4556"   # Decorate Behaviors
    command: ["start", "--allowInjection", "--loglevel", "warn"]
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:2525/', r => process.exit(r.statusCode === 200 ? 0 : 1))\""]
      interval: 5s
      timeout: 3s
      retries: 10

  # Rift (Mountebank-compatible mode)
  rift:
    build:
      context: ../..
      dockerfile: crates/rift-http-proxy/Dockerfile
    container_name: rift-bench
    ports:
      - "3525:2525"   # Admin API (mapped to different host port)
      - "5545:4545"   # API Server
      - "5546:4546"   # Regex Matcher
      - "5547:4547"   # Complex Predicates
      - "5548:4548"   # Behaviors
      - "5549:4549"   # Simple Baseline
      - "5550:4550"   # JSON Body Matcher
      - "5551:4551"   # JSONPath Matcher
      - "5552:4552"   # XPath Matcher
      - "5553:4553"   # Template Responses
      - "5554:4554"   # Header Router
      - "5555:4555"   # Query Param Matcher
      - "5556:4556"   # Decorate Behaviors
      - "9090:9090"   # Metrics
    environment:
      - MB_PORT=2525
      - MB_ALLOW_INJECTION=true
      - RUST_LOG=warn
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2525/"]
      interval: 5s
      timeout: 3s
      retries: 10

networks:
  default:
    name: rift-benchmark
